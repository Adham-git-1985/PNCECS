{% extends "layout.html" %}
{% block title %}{{ t('achievement_reports') }} - ({{ pick('Ù…Ø­Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„', 'Fully Local') }}){% endblock %}

{% block content %}
<div class="container my-5">

  <h2 class="text-primary mb-4 text-center fs-2">{{ t('achievement_reports') }}</h2>
<div class="container my-4">
  <div class="row g-3">
    <aside class="col-lg-3">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3" style="color:#cdab35;">ğŸ“ {{ t('achievement_reports') }}</h2>
          <input id="search" type="search" class="form-control mb-2"
                 placeholder="{{ pick('Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ‚Ø±ÙŠØ±...', 'Search for a report...') }}"
                 aria-label="{{ pick('Ø§Ø¨Ø­Ø« Ø¹Ù† ØªÙ‚Ø±ÙŠØ±', 'Search reports') }}">
          <div class="list-group small" id="reportList" style="max-height:60vh; overflow:auto; border:1px solid #eee; border-radius:8px;">
           {% for rep in reports %}
              <button type="button"
                class="list-group-item list-group-item-action d-flex align-items-start gap-2 {% if loop.first %}active{% endif %}"
                data-pdf="{{ url_for('static', filename=rep.file_path) }}"
                data-title="{{ rep.title|e }}">
                <div class="flex-fill text-start">
                  <div class="fw-bold">{{ rep.title }}</div>
                </div>
                <span class="ms-auto">â†—</span>
              </button>
            {% else %}
              <div class="p-3 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ø¹Ø¯.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </aside>

    <section class="col-lg-9">
      {% set initial = reports[0] if reports else None %}
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 id="viewerTitle" class="h5 mb-0">{{ l(initial, 'title') if initial else 'â€”' }}</h1>
        <div class="btn-group">
          <a id="btnDownload" class="btn btn-outline-secondary"
             href="{{ url_for('static', filename=initial.file_path) if initial else '#' }}" download>
            {{ pick('ØªØ­Ù…ÙŠÙ„', 'Download') }}
          </a>
          <a id="btnOpenNew" class="btn btn-outline-secondary" target="_blank" rel="noopener noreferrer"
             href="{{ url_for('static', filename=initial.file_path) if initial else '#' }}">
            {{ pick('ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯', 'Open in new tab') }}
          </a>
        </div>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div id="pdfContainer">
            <div id="pdfViewer" class="text-center">
              <canvas id="pdfCanvas" style="max-width:100%; border:1px solid #cdab35; border-radius:8px;"></canvas>
            </div>
            <div class="d-flex flex-wrap justify-content-center align-items-center gap-2 mt-3" id="toolbar">
              <button id="prevPage" class="btn btn-sm btn-outline-secondary">{{ t('prev') }}</button>
              <span class="small">
                {{ pick('Ø§Ù„ØµÙØ­Ø©', 'Page') }} <span id="pageNum">1</span> / <span id="pageCount">?</span>
              </span>
              <button id="nextPage" class="btn btn-sm btn-outline-secondary">{{ t('next') }}</button>
              <div class="d-flex align-items-center ms-3">
                <label for="zoom" class="me-2 small mb-0">{{ pick('Ø§Ù„ØªÙƒØ¨ÙŠØ±', 'Zoom') }}</label>
                <input id="zoom" type="range" min="50" max="200" value="110" class="form-range" style="width:180px">
                <span class="small ms-2"><span id="zoomLabel">110</span>%</span>
              </div>
            </div>
          </div>

          <div id="fallbackBox" class="d-none">
            <div class="ratio ratio-16x9 border" style="border-color:#cdab35; border-radius:8px;">
              <object id="fallbackObj" data="#" type="application/pdf" width="100%" height="100%">
                <embed id="fallbackEmbed" src="#" type="application/pdf" />
                <p class="p-3">
                  {{ pick('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§.', 'The file cannot be displayed here.') }}
                  <a id="fallbackLink" href="#" target="_blank" rel="noopener">
                    {{ pick('Ø§ÙØªØ­Ù‡ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯', 'Open it in a new tab') }}
                  </a>.
                </p>
              </object>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Ø­Ù…Ù‘Ù„ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ù…Ù† pdf.min.js ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ -->
<script src="{{ url_for('static', filename='vendor/pdfjs/pdf.min.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const STR_RENDER_ERR = "{{ pick('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¨Ø¯ÙŠÙ„.', 'Render error occurred; using fallback viewer.') }}";
  const STR_LOAD_WARN  = "{{ pick('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„ÙŠØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¨Ø¯ÙŠÙ„.', 'Local viewer not found; switching to fallback.') }}";

  const canvas = document.getElementById('pdfCanvas');
  const ctx = canvas.getContext('2d');
  const pageNumLabel = document.getElementById('pageNum');
  const pageCountLabel = document.getElementById('pageCount');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');
  const zoom = document.getElementById('zoom');
  const zoomLabel = document.getElementById('zoomLabel');
  const reportList = document.getElementById('reportList');
  const viewerTitle = document.getElementById('viewerTitle');
  const btnDownload = document.getElementById('btnDownload');
  const btnOpenNew = document.getElementById('btnOpenNew');

  const pdfContainer = document.getElementById('pdfContainer');
  const fallbackBox = document.getElementById('fallbackBox');
  const fbObj = document.getElementById('fallbackObj');
  const fbEmbed = document.getElementById('fallbackEmbed');
  const fbLink = document.getElementById('fallbackLink');

  let pdfDoc = null, pageNum = 1, rendering = false, pending = null, currentUrl = null;

  function useFallback(url){
    pdfContainer.classList.add('d-none');
    fallbackBox.classList.remove('d-none');
    fbObj.data = url;
    fbEmbed.src = url;
    fbLink.href = url;
  }

  function renderPage(num) {
    rendering = true;
    pdfDoc.getPage(num).then(page => {
      const scale = parseInt(zoom.value, 10) / 100;
      const viewport = page.getViewport({ scale: scale * 1.15 });
      canvas.width = viewport.width;
      canvas.height = viewport.height;

      page.render({ canvasContext: ctx, viewport }).promise.then(() => {
        rendering = false;
        if (pending !== null) {
          renderPage(pending);
          pending = null;
        }
      });

      pageNumLabel.textContent = num;
      zoomLabel.textContent = zoom.value;
    }).catch(err => {
      console.error('Render error:', err);
      console.warn(STR_RENDER_ERR);
      useFallback(currentUrl);
    });
  }

  function queueRender(num) {
    if (rendering) pending = num;
    else renderPage(num);
  }

  function onPrev() {
    if (!pdfDoc || pageNum <= 1) return;
    pageNum--;
    queueRender(pageNum);
  }

  function onNext() {
    if (!pdfDoc || pageNum >= pdfDoc.numPages) return;
    pageNum++;
    queueRender(pageNum);
  }

  function loadPdf(url, title) {
    currentUrl = url;
    viewerTitle.textContent = title || 'â€”';
    btnDownload.href = url;
    btnOpenNew.href = url;

    if (!url || url === '#') { return; }

    if (!window.pdfjsLib) {
      console.warn('pdf.min.js (local) not found â€” using fallback viewer');
      console.warn(STR_LOAD_WARN);
      useFallback(url);
      return;
    }

    pdfjsLib.GlobalWorkerOptions.workerSrc = "{{ url_for('static', filename='vendor/pdfjs/pdf.worker.min.js') }}";

    pdfjsLib.getDocument(url).promise.then(doc => {
      pdfDoc = doc;
      pageNum = 1;
      pageCountLabel.textContent = pdfDoc.numPages || '?';
      fallbackBox.classList.add('d-none');
      pdfContainer.classList.remove('d-none');
      renderPage(pageNum);
    }).catch(err => {
      console.warn('Load error -> using fallback viewer:', err);
      useFallback(url);
    });
  }

  reportList.addEventListener('click', (e) => {
    const btn = e.target.closest('.list-group-item');
    if (!btn) return;
    reportList.querySelectorAll('.list-group-item').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadPdf(btn.dataset.pdf, btn.dataset.title);
  });

  prevBtn?.addEventListener('click', onPrev);
  nextBtn?.addEventListener('click', onNext);
  zoom?.addEventListener('input', () => queueRender(pageNum));

  // Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
  const first = reportList.querySelector('.list-group-item.active') || reportList.querySelector('.list-group-item');
  if (first) first.click();
});
</script>
</div>
{% endblock %}
